<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Seminar 4: Linear Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="04_seminar_exercises_files/libs/clipboard/clipboard.min.js"></script>
<script src="04_seminar_exercises_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="04_seminar_exercises_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="04_seminar_exercises_files/libs/quarto-html/popper.min.js"></script>
<script src="04_seminar_exercises_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="04_seminar_exercises_files/libs/quarto-html/anchor.min.js"></script>
<link href="04_seminar_exercises_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="04_seminar_exercises_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="04_seminar_exercises_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="04_seminar_exercises_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="04_seminar_exercises_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#plan-for-today" id="toc-plan-for-today" class="nav-link active" data-scroll-target="#plan-for-today">Plan for Today</a></li>
  <li><a href="#part-1-bivariate-regression" id="toc-part-1-bivariate-regression" class="nav-link" data-scroll-target="#part-1-bivariate-regression">Part 1: Bivariate Regression</a>
  <ul class="collapse">
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation">Estimation</a></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction">Prediction</a></li>
  <li><a href="#functional-form" id="toc-functional-form" class="nav-link" data-scroll-target="#functional-form">Functional Form</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a></li>
  </ul></li>
  <li><a href="#part-2-multivariate-regression" id="toc-part-2-multivariate-regression" class="nav-link" data-scroll-target="#part-2-multivariate-regression">Part 2: Multivariate Regression</a></li>
  <li><a href="#part-3-diagnostics-and-residuals" id="toc-part-3-diagnostics-and-residuals" class="nav-link" data-scroll-target="#part-3-diagnostics-and-residuals">Part 3: Diagnostics and Residuals</a></li>
  <li><a href="#part-4-controlling-for-as-partialling-out" id="toc-part-4-controlling-for-as-partialling-out" class="nav-link" data-scroll-target="#part-4-controlling-for-as-partialling-out">Part 4: Controlling for as Partialling-Out</a></li>
  <li><a href="#part-5-regression-using-python" id="toc-part-5-regression-using-python" class="nav-link" data-scroll-target="#part-5-regression-using-python">Part 5: Regression using Python</a></li>
  <li><a href="#sec-inference" id="toc-sec-inference" class="nav-link" data-scroll-target="#sec-inference">BONUS: Calculating Inferential Statistics Yourself</a>
  <ul class="collapse">
  <li><a href="#asymptotic-inference" id="toc-asymptotic-inference" class="nav-link" data-scroll-target="#asymptotic-inference">Asymptotic Inference</a></li>
  <li><a href="#robust-bootstrapped-standard-errors" id="toc-robust-bootstrapped-standard-errors" class="nav-link" data-scroll-target="#robust-bootstrapped-standard-errors">Robust &amp; Bootstrapped Standard Errors</a></li>
  </ul></li>
  <li><a href="#by-the-end-of-this-seminar-you-should-be-able-to" id="toc-by-the-end-of-this-seminar-you-should-be-able-to" class="nav-link" data-scroll-target="#by-the-end-of-this-seminar-you-should-be-able-to">By the end of this seminar, you should be able to…</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Seminar 4: Linear Regression</h1>
<p class="subtitle lead">LSE ME314: Introduction to Data Science and Machine Learning</p>
</div>



<div class="quarto-title-meta">

    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">July 15, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="plan-for-today" class="level2">
<h2 class="anchored" data-anchor-id="plan-for-today">Plan for Today</h2>
<ul>
<li>Learn how to estimate bivariate and multivariate regressions</li>
<li>Learn how to obtain and interpret coefficients and inferential statistics</li>
<li>Learn how to make predictions based on a linear model</li>
<li>Learn how to obtain model diagnostics and how to interpret them</li>
<li>Learn how to output nicely formatted regression tables</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>package_check <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">need =</span> <span class="fu">c</span>()) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    have <span class="ot">&lt;-</span> need <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()) <span class="co"># checks packages you have</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="sc">!</span>have)) <span class="fu">install.packages</span>(need[<span class="sc">!</span>have]) <span class="co"># install missing packages</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">invisible</span>(<span class="fu">lapply</span>(need, library, <span class="at">character.only =</span> T))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>required_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dplyr"</span>, <span class="co"># for data management</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"broom"</span>, <span class="co"># for tidying model outputs</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"estimatr"</span>, <span class="co"># for regression with robust standard errors</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"modelsummary"</span>, <span class="co"># for prettier model output tables</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ggplot2"</span>, <span class="co"># for plotting</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidyr"</span>, <span class="co"># for data transformation</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tibble"</span>, <span class="co"># for plotting,</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span> <span class="co"># for working with python in quarto</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">package_check</span>(required_packages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up reticulate</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#library(reticulate) do we need this?</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">use_python</span>(<span class="st">"/opt/miniconda3/envs/quarto-python/bin/python"</span>, <span class="at">required =</span> <span class="cn">TRUE</span>) <span class="co"># change this path to your python installation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># macOS</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">--user</span> statsmodels scikit-learn</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#/opt/miniconda3/envs/quarto-python/bin/pip install statsmodels scikit-learn</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># windows</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> pip install statsmodels scikit-learn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries and load data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="part-1-bivariate-regression" class="level1">
<h1>Part 1: Bivariate Regression</h1>
<p>When working with R, there are a bunch of pre-installed datasets that are easily accessible. You will find that they are often used in examples and exercises online, in class, or in the documentation of R packages. One of the most commonly used datasets is called <code>mtcars</code> , which contains information about various car models and their specifications (based on reports in a 1974 US magazine). To see information about the variables of pre-installed datasets, you can use the <code>?</code> operator.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>?mtcars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will use this dataset to estimate the association between the weight of a car (<code>wt</code>) and its miles per gallon (<code>mpg</code>). Before estimating the model, let’s get a better understanding of the data.</p>
<p>Use the <code>head()</code>, <code>summary()</code>, and <code>glimpse()</code> functions to explore the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also visualise the relationship between the two variables using a scatter plot. This will help us understand the nature of the relationship before we fit a linear regression model.</p>
<p>Create a scatterplot with <code>wt</code> on the x-axis and <code>mpg</code> on the y-axis. Use the <code>ggplot2</code> package to create the plot and assign it to an object called <code>scatterplot</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ok, we can see that there is a negative relationship between car weight and miles per gallon. Just from looking at the scatterplot, what do you think are appropriate values for the intercept and the slope of the regression line? Try out a few variables and add them to the scatterplot by changing respective values the <code>geom_abline()</code> function below.</p>
<p>Let’s add a straight line of best fit to the plot to make it even clearer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>scatterplot_guess <span class="ot">&lt;-</span> scatterplot<span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> ___, <span class="at">slope =</span> ____, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>scatterplot_guess</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once you are happy with your guess, let’s see well you did! Use the <code>geom_smooth()</code> function to add a straight regression line to the plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>scatterplot_guess <span class="sc">+</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Under the hood, the <code>geom_smooth()</code> function estimates a model and then uses its result to fit the a line to the data. <code>method = "lm"</code> means that the function estimates a “<strong>l</strong>inear <strong>m</strong>odel,” which is what we are now going to do manually.</p>
<section id="estimation" class="level2">
<h2 class="anchored" data-anchor-id="estimation">Estimation</h2>
<p>The R command to estimate a linear regression model is <code>lm()</code>. To fit a regression, you specify a <em>formula</em> that describes the relationship between the dependent and the independent variable like this:</p>
<p><code>y ~ x</code></p>
<p>The variable names must correspond to column names in a dataframe that you specify in the <code>data</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>car_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="at">formula =</span> ______, <span class="at">data =</span> mtcars)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>car_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Questions:</strong></p>
<ul>
<li>Based on our model, what is the expected value of Y at x = 0?</li>
<li>Based on our model, what is the expected change in Y for a one unit increase in X?</li>
</ul>
<p>Use the <code>geom_abline()</code> function to add our estimated regression line and the intercept to the plot. Don’t hard-code the slope and intercept, but extract them from the model using <code>coef()</code> and appropriate indexing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>car_slope <span class="ot">&lt;-</span> <span class="fu">coef</span>(car_model)[[<span class="st">"wt"</span>]]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>car_intercept <span class="ot">&lt;-</span> <span class="fu">coef</span>(car_model)[[<span class="st">"(Intercept)"</span>]]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>scatterplot <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">fullrange =</span> T) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">slope =</span> car_slope, <span class="at">intercept =</span> car_intercept,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"point"</span>, <span class="at">x =</span> ______, <span class="at">y =</span> _________, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">8</span>, <span class="at">shape =</span> <span class="dv">18</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see, the two lines are identical and the intercept is simply the point on the regression line where X is zero.</p>
<p><strong>Questions:</strong></p>
<ol type="1">
<li>Think a moment about the interpretation of the intercept. Is it meaningful?</li>
<li>Think a moment about the functional form of the relationship. Do you think it is specified correctly? Is <code>mpg</code> a linear function of weight and a normally distributed error term with a mean of 0?</li>
</ol>
</section>
<section id="prediction" class="level2">
<h2 class="anchored" data-anchor-id="prediction">Prediction</h2>
<p>Let’s put our model to use! Below, you see a picture of the ZIL-41047, the Soviet state car that was used by Mikhail Gorbachev. It is quite heavy (around 7000 pounds)! Lets use the linear model to predict how many miles this gargantuan car can drive on one gallon of gas.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/gorbi_car.jpg" class="img-fluid figure-img" width="400"></p>
<figcaption>Gorbachev’s 700 lbs Limousine</figcaption>
</figure>
</div>
<p>You can predict values of Y on the regression line by hand or through the <code>predict()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(car_model)[[<span class="st">"(Intercept)"</span>]] <span class="sc">+</span> <span class="dv">7</span> <span class="sc">*</span> <span class="fu">coef</span>(car_model)[[<span class="st">"wt"</span>]]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively (and in more complex cases) you can use the `predict()` function:</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(car_model, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">wt =</span> <span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first method is useful for understanding the mechanics of regression, while the second is more practical for larger datasets or more complex models. Note that both methods simply solve the following equation:</p>
<p><span class="math display">\[
\hat{y} =\beta_0 + \beta_1 \times 7
\]</span></p>
<p><strong>Questions:</strong></p>
<ol type="1">
<li>What does our model predict? How many miles could Gorbachev travel on one gallon?</li>
<li>What do you make of the negative prediction? Why is it implausible?</li>
</ol>
<p>In case you were wondering, the lightest car ever produced is the <em>Peel P50</em>, a tiny car manufactured on the <em>Isle of Man</em> in the sixties. It was small enough to be stored in a van.</p>
<div class="columns">
<div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/P50_1.jpg" height="150" class="figure-img"></p>
<figcaption>The Peel P50…</figcaption>
</figure>
</div>
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figs/P50_2.jpg" height="150" class="figure-img"></p>
<figcaption>… neatly fits into another car</figcaption>
</figure>
</div>
</div>
</div>
<p>The original car weighs only 130 pounds! Predict its <code>mpg</code> using our model and the <code>predict()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="functional-form" class="level2">
<h2 class="anchored" data-anchor-id="functional-form">Functional Form</h2>
<p>The predictions for extreme cars were not very good. Are we getting the functional form wrong? Recall that we already saw that even within our sample, we are getting larger residuals at the extremes.</p>
<p>Adapt the <code>formula</code> argument in <code>geom_smooth()</code> to plot models that include additional polynomials of <code>wt</code> as predictors. When transforming a variable in a formula, wrap your transformation in <code>I()</code>. For example, to use the square of <code>wt</code> as a predictor, write <code>I(wt^2)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>scatterplot <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y <span class="sc">~</span> x,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> <span class="co"># leave this as reference</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y <span class="sc">~</span> x <span class="sc">+</span> ___________, <span class="co"># adapt the functional form </span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on the visualisation AND your knowledge about the data generating process, select one of the models you plotted and estimate it using the <code>lm()</code> function. Then, use the <code>predict()</code> function to predict the <code>mpg</code> of the Peel P50 and Gorbachev’s limousine. Does your model do a better job than <code>car_model</code>? The true <code>mpg</code> of the Peel P50 is 83, while Gorbachev’s limousine has a true <code>mpg</code> of 8.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>car_model_poly <span class="ot">&lt;-</span> __________</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a prediction dataset with the values we want to predict and the true values of Y.</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>newdata_cars <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">wt =</span> <span class="fu">c</span>(<span class="dv">7</span>, .<span class="dv">13</span>),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mpg =</span> <span class="fu">c</span>(<span class="fl">8.5</span>, <span class="dv">83</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># by assigning row names, the prediction output will be easier to read</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(newdata_cars) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ZIL-41047"</span>, <span class="st">"P50"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># predict the values </span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>prediction_poly <span class="ot">&lt;-</span> ____________________</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># add the predictions as a column called `mpg_hat` in the newdata_cars dataframe</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>____________ <span class="ot">&lt;-</span> ______________________</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect the result</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>newdata_cars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you have the time, add the line predicted by car_model_poly, your predictions for P50 and ZIL-41047 and the true values to the scatterplot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<p>The output we obtained from the regression model above was a bit underwhelming. To see more information about the model, we can use the <code>summary()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now this is far more informative! There are some summary stats about the distribution of the residuals, and a coefficient block with estimates, standard errors, t-values, and p-values.</p>
<p>We interpreted the coefficients above already, let’s now focus on statistical significance. R has computed a number of statistics for us, if you want to learn more about how they are related and calculated manually, check out the <a href="#sec-inference">Bonus section</a> at home.</p>
<dl>
<dt>Standard Errors</dt>
<dd>
<p>Let’s begin with the standard error. In asymptotic statistics, the standard error of a coefficient is the estimated standard deviation of the sampling distribution of the coefficient. In other words, it tells us how much the coefficient would vary on average if we were to repeatedly sample from the population and estimate the model. So when the standard error is small, it means that the coefficient is estimated with high precision, and vice versa.</p>
</dd>
</dl>
<p>The standard error of <code>wt</code> is 0.56. This means that if we were to repeatedly sample from the population and estimate the model, we would expect the coefficient of <code>wt</code> to vary by about <span class="math inline">\(\pm 0.56\)</span> on average. While we might obtain a few coefficient estimates that are very different from the one we got, most of them will be close to the estimate we found.</p>
<dl>
<dt>T-statistic</dt>
<dd>
<p>While the SE is usually the cornerstone of inference, it is on the scale of X and not as easily interpretable. People are therefore often more interested in the p-value. We can obtain the p-value by first estimating the t-statistic, which is simply the coefficient divided by its standard error: <span class="math inline">\(\frac{-5.3445}{0.56} \approx -9.54\)</span>. The t-statistic is essentially the number of standard errors, the coefficient is away from zero. We know the properties of the t-distribution, so given the t-statistic (and the degrees of freedom of our model), we can look up the corresponding p-value. The t-statistic is not usually interpreted in isolation, but mainly used to calculate the p-value.</p>
</dd>
<dt>P-values</dt>
<dd>
<p>The most common statistic used to assess significance is the p-value. It tells us the probability of observing a t-statistic as extreme as the one we found, given that the null hypothesis is true. So if the p-value is 0.01, there is a 1% probability of being unlucky and observing a value as extreme as the one we found even though the true coefficient is actually zero.</p>
</dd>
</dl>
<p>Imagine the following scenario: you have a population from which you draw a random sample. You estimate the coefficient and obtain a p-value of 0.01. If you were to repeat this process another 99 times, you would expect to find one instance where the coefficient is significant at the 0.01 level by chance alone, even if the true coefficient is actually zero. Obviousely, it is usually impossible to repeat the sampling process, but if you obtained a p-value of 0.01, you know that either the true coefficient is not zero or you drew a very unlikely sample.</p>
<p>Our p-value is 1.29e-10, which is scientific notation for 0.000000000129. So either the null hypothesis is false, or we drew a <span class="math inline">\(\frac{1}{7,751,937,984} = 1.29e^{-10}\)</span> sample – which seems rather unlikely.</p>
<p>It is very common to set a significance level <span class="math inline">\(\alpha\)</span> a priori and then reject the null hypothesis if the p-value is below that level. The most common significance levels are 0.05, 0.01, and 0.001 and whether a coefficient is significant at a certain level is often indicated by stars in the output. Note that these levels are completely arbitrary. It is generally a good idea not to get overly fixated on p-values and significance, and to focus on design choices and substantive interpretation first!</p>
<dl>
<dt>Confidence Intervals</dt>
<dd>
<p>Finally, while the <code>summary()</code> output does not show it, we can also obtain confidence intervals for the coefficients:</p>
</dd>
</dl>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>(car_model, <span class="at">level =</span> <span class="fl">0.95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We calculated 95% confidence intervals using the <code>confint()</code> function. They are interpreted as follows: If we were to repeat the sampling process (and estimation) an infinite number of times, 95% of the confidence intervals obtained would contain the true coefficient. You can estimate confidence intervals for any level. Naturally, the higher the confidence level, the wider the interval.</p>
<p>Estimate confidence intervals that – on expectation – contain the true coefficient in 99.9% of the hypothetical resamples. Then, estimate confidence intervals that <strong>always</strong> contain the true coefficient. What do you expect them to look like?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="part-2-multivariate-regression" class="level1">
<h1>Part 2: Multivariate Regression</h1>
<p>We use the same function (<code>lm()</code>) for multivariate regression that we used for bivariate regression. All we have to change is the formula. To estimate the relationship between <span class="math inline">\(Y\)</span> and several predictors <span class="math inline">\(X1\)</span>, <span class="math inline">\(X2\)</span> and <span class="math inline">\(X3\)</span>, simply write:</p>
<p><code>lm(y ~ x1 + x2 + x3, data = dataframe)</code></p>
<p>Let’s move to a more interesting dataset for multivariate regression. Load the <code>ESS9_immatt.rds</code> dataset and assign it to an object called <code>ess_data</code>. Take a look at the variables it contains.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data are for <em>n</em>=33706 respondents in the European Social Survey (ESS) in 2018. The response variable in the dataset is</p>
<ul>
<li><code>immatt</code>: a measure of respondent’s attitude to immigration, with higher values indicating more positive attitudes</li>
</ul>
<p>Suppose that our research question is one of descriptive association: How are attitudes to immigration of the individuals in these data [and in the population they represent] associated with some characteristics of the individuals? We consider two independent variables:</p>
<ul>
<li><code>educ</code>: respondent’s education, in years of school completed</li>
<li><code>hhnetinc</code>: respondent’s household’s equivalised total net income, coded as the decile in the distribution of this income within the respondent’s country (1=lowest 10%, 2=second 10%, …, 10=highest 10%)</li>
</ul>
<p>Let’s first summarise the relevant variables to get a better understanding of the data. Subset the data to only include the variables of interest and then inspect the dataset distribution of the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Estimate a bivariate regression model with <code>immatt</code> as the dependent variable and <code>hhnetinc</code> as the independent variable and then a multivariate model with <code>hhnetinc</code> and <code>educ</code> as independent variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Questions:</strong></p>
<ol type="1">
<li>What is the substantive interpretation of the Intercept?</li>
<li>Why does the intercept change from the bivariate to the multivariate model?</li>
<li>What is the interpretation of the coefficient for <code>hhnetinc</code> in each of the models?</li>
<li>Interpret the p-value of the coefficient for <code>educ</code> in the multivariate model.</li>
<li>Why is the coefficient for <code>hhnetinc</code> in the multivariate model smaller than in the bivariate model?</li>
</ol>
<p>Now, use the <code>predict()</code> function to predict immigration attitudes for three respondents with the following properties:</p>
<ol type="1">
<li>income in 7th decile, 15 years of education</li>
<li>income in 10th decile, 2 years of education</li>
<li>income in 7th decile, 22 years of education</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Question:</strong></p>
<p>How do the predictions compare? Do you find all predictions similarly informative? Why/why not?</p>
</section>
<section id="part-3-diagnostics-and-residuals" class="level1">
<h1>Part 3: Diagnostics and Residuals</h1>
<p>While we can fit regression lines to virtually all data, whether our point estimates and (especially) the inferential statistics are what we think they are, depends on several assumptions. Both theoretical considerations and empirical tests can help establish whether these assumptions are met or violated.</p>
<p>To recap the assumptions of linear regression:</p>
<ol type="1">
<li>Linearity: The relationship between the independent and dependent variables is linear (possibly after variable transformation). In other words: The true relationship between Y and X is linear in the parameters</li>
<li>Independence/I.i.d random sample: The sample is a random draw.</li>
<li>No multicollinearity: The independent variables are not perfectly correlated with each other.</li>
<li>Zero conditional mean <span class="math inline">\(E[\epsilon \mid X] = 0\)</span>: all the systematic components in the DGP are in our estimator.</li>
<li>Homoscedasticity/No heteroscedasticity: The variance of the error term is constant across all levels of the independent variable.</li>
</ol>
<p>By inspecting the residuals, we can learn something about assumptions 1 and 5. You can access the residuals of a model using the <code>residuals()</code> function. Let’s visualise the residuals of our previous <code>car_model</code> in the scatter plot we created earlier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get residuals</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>car_residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(car_model)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># save residuals, real values, and predicted values in a dataframe</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>residual_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">wt =</span> mtcars<span class="sc">$</span>wt, </span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mpg =</span> mtcars<span class="sc">$</span>mpg,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">residuals =</span> car_residuals,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">predicted =</span> <span class="fu">predict</span>(car_model)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>scatterplot<span class="sc">+</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_linerange</span>(<span class="at">data =</span> residual_df, <span class="fu">aes</span>(<span class="at">x =</span> wt, <span class="at">ymin =</span> predicted, <span class="at">ymax =</span> predicted <span class="sc">+</span> residuals), </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="sc">-</span><span class="fl">5.344</span>, <span class="at">intercept =</span> <span class="fl">37.285</span>, </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One straightforward diagnostic is plotting the residuals against X (or <code>wt</code> in our case). That way, we can see whether the variance is constant across X (homoscedastic) and whether there is any pattern in the residuals that would suggest that we misspecified the relationship between X and Y. Use the {ggplot2} package and the <code>residual_df</code> dataframe to do that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The variance in the residuals does not seem to depend on X, but there seems to be a U-shaped relationship between <code>wt</code> and the residuals. This suggests that the relationship may not be linear. Let’s investigate this further.</p>
<p>R provides some default diagnostic plots that can help us check the assumptions of the regression model. You can use the <code>plot()</code> function on a model object to generate these plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># diagnostic plots</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>)) <span class="co"># set up a 2x2 plotting area</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(car_model)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)) <span class="co"># reset to single plot     </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s walk through the four plots (you can find more information by typing <code>?plot.lm()</code> in the console):</p>
<ol type="1">
<li><p><strong>Residuals vs.&nbsp;Fitted</strong>: This plot helps us detect non-linearity. It is very similar to the plot we just created, but it plots the residuals against the fitted values, not X. That way, the plot can be created for bivariate and multi-variate models. We want to watch out for patterns in the red line, as they would suggest that the accuracy of our predictions changes by the independent variable(s). We can see a slight U shape in the relationship. This indicates that our residuals are larger (meaning that predictions are less accurate) for very light and very heavy cars.</p></li>
<li><p><strong>Q-Q Residuals</strong>: This plot helps us assess the normality of the residuals. It relates the standardised residuals to the theoretical quantiles of a normal distribution. If the residuals follow a normal distribution, their standardised values and the theoretical quantiles should fall approximately along the reference line. Our residuals fit the theoretical line quite well.</p></li>
<li><p><strong>Scale-Location</strong>: This plot helps us check for homoscedasticity. It shows the square root of the standardised absolute residuals against the fitted values. We want to see a horizontal line with equally spread points. If the points fan out or form a pattern, it suggests heteroscedasticity. In our case, the points are fairly evenly distributed around the horizontal line, indicating that the variance of the residuals is constant across all levels of the independent variable.</p></li>
<li><p><strong>Residuals vs.&nbsp;Leverage</strong>: This plot helps in identifying influential outliers. The x-axis maps each point’s <em>leverage</em>, a measure of how strongly each value influences the overall result. On the y-axis, you see the standardised residuals once more. Watch out for points with high leverage and big residuals (both positive and negative). The model might not be robust to removing these outliers and coefficients may be mainly driven by some, perhaps odd or false, measurements.</p></li>
</ol>
</section>
<section id="part-4-controlling-for-as-partialling-out" class="level1">
<h1>Part 4: Controlling for as Partialling-Out</h1>
<p>While you will usually compute multivariate regressions like we did above, we could also estimate the relationship between <code>hhnetinc</code> and <code>immatt</code> controlling for <code>educ</code> by first eliminating the variance due to <code>educ</code> in both our dependent and independent variable. We can do this by estimating two bivariate regressions (with our dependent and independent variables of interest as dependent variables and the variable whose influence we want to remove as predictor) and then use the residuals from these models in a new regression. This is called <em>partialling out</em>. Try it out below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain residuals from bivariate regression of immat on educ</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>immatt_residuals <span class="ot">&lt;-</span> <span class="fu">resid</span>(<span class="fu">lm</span>(_______ <span class="sc">~</span> _______, <span class="at">data =</span> ess_data))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain residuals from bivariate regression of hhnetinc on educ</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>hhnetinc_residuals <span class="ot">&lt;-</span> <span class="fu">resid</span>(<span class="fu">lm</span>(_______ <span class="sc">~</span> _______, <span class="at">data =</span> ess_data))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate relationship between residuals</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(immat_model_po <span class="ot">&lt;-</span> <span class="fu">lm</span>(_______ <span class="sc">~</span> _______, <span class="at">data =</span> ess_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets compare this model with the bivariate and multivariate models we estimated above. A neat way to do this is to use the <code>modelsummary</code> package, which creates nice tables with the results of several models, one in each column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">modelsummary</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">bivariate =</span> immatt_model_biv, <span class="at">multivariate =</span> immatt_model_multi, <span class="at">multivariate_partialing_out =</span> immat_model_po),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">coef_rename =</span> <span class="fu">c</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hhnetinc"</span> <span class="ot">=</span> <span class="st">"Household income (decile)"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"educ"</span> <span class="ot">=</span> <span class="st">"Education (years)"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hhnetinc_residuals"</span> <span class="ot">=</span> <span class="st">"Household income (decile, residuals)"</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">stars =</span> T,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="fu">c</span>(<span class="st">"SE: {std.error}"</span>, <span class="st">"t: {statistic}"</span>, <span class="st">"p: {p.value}"</span>),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">output =</span> <span class="st">"html"</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">gof_map =</span> <span class="fu">c</span>(</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nobs"</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r.squared"</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Regression Results: Immigration Attitudes"</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="part-5-regression-using-python" class="level1">
<h1>Part 5: Regression using Python</h1>
<p>Python has a range of packages for regression analysis. For today, we will use the formula API of the {statsmodels} package, which allows us to use R-style formulas to specify our models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load mtcars dataset from R environment</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>mtcars <span class="op">=</span> r.mtcars <span class="co"># this is reticulate magic, converting an R object to a Python object</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit regression using R-style formula</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> smf.ols(<span class="st">'mpg ~ wt'</span>, data<span class="op">=</span>mtcars).fit()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.params)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.summary())</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract coefficients </span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Intercept: </span><span class="sc">{</span>model<span class="sc">.</span>params[<span class="st">'Intercept'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Weight: </span><span class="sc">{</span>model<span class="sc">.</span>params[<span class="st">'wt'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>new_data <span class="op">=</span> pd.DataFrame({<span class="st">'wt'</span>: [<span class="dv">7</span>, <span class="fl">0.13</span>]})  <span class="co"># Gorbachev's limo &amp; Peel P50</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.predict(new_data)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(predictions.iloc[<span class="dv">0</span>])</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>predictions[<span class="dv">0</span>]</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>predictions[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extend the code above to estimate a multivariate regression, output the coefficients, and a summary of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your code goes here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-inference" class="level1">
<h1>BONUS: Calculating Inferential Statistics Yourself</h1>
<section id="asymptotic-inference" class="level2">
<h2 class="anchored" data-anchor-id="asymptotic-inference">Asymptotic Inference</h2>
<p>R calculates a range of inferential statistics for us, including the standard error, t-value, and p-value. However, it is useful to understand how these statistics are calculated and related and how you could calculate them yourself.</p>
<p>Usually, the most fundamental statistic we are interested in is the standard error of the coefficient. In the bivariate case, the standard error of the coefficient (<span class="math inline">\(\hat{se}(\hat{\beta})\)</span>) is given by:</p>
<p><span class="math display">\[
\begin{align}
\hat{\text{se}}(\hat{\beta}) =&amp; \frac{\hat\sigma}{\sqrt{\sum(X_i - \bar{X})^2}}\\
=&amp;\frac{\hat\sigma}{s_{x}\sqrt{n-1}}
\end{align}
\]</span></p>
<p>where</p>
<p><span class="math inline">\(\sigma^2\)</span> is the residual standard deviation, <span class="math inline">\(\bar{X}\)</span> is the mean of <span class="math inline">\(X\)</span>, <span class="math inline">\(s_x\)</span> is the standard deviation of <span class="math inline">\(X\)</span> and <span class="math inline">\(n\)</span> is the number of observations.</p>
<p>We can do this by hand (this only works for bivariate regression but other formulas exist for the multivariate case):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract residual standard error</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>sigma_hat <span class="ot">&lt;-</span> <span class="fu">summary</span>(car_model)<span class="sc">$</span>sigma</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>car_model_wt_se <span class="ot">&lt;-</span> sigma_hat <span class="sc">/</span> (<span class="fu">sqrt</span>(<span class="fu">sum</span>((mtcars<span class="sc">$</span>wt <span class="sc">-</span> <span class="fu">mean</span>(mtcars<span class="sc">$</span>wt))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>car_model_wt_se</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># This formula yields the same result</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>sigma_hat <span class="sc">/</span> (<span class="fu">sd</span>(mtcars<span class="sc">$</span>wt) <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="fu">length</span>(mtcars<span class="sc">$</span>wt) <span class="sc">-</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a nice formula, but what is the standard error trying to capture? The standard error estimates the standard deviation of the sampling distribution - that is, how much our coefficient would vary across many hypothetical samples from the same population.</p>
<p>While we can’t actually repeat our study infinitely, we can demonstrate this concept through simulation. The code below simulates a large population, draws one random sample, and estimates the mean and its standard error (the same principle applies to any regression coefficient).</p>
<p>We then draw many samples and calculate the mean for each. The standard deviation of these sample means should match our estimated standard error - let’s see if it does:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1111</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate a population with a mean value of 2</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>population <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10000</span>, <span class="at">mean =</span> <span class="dv">2</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the researcher draws a random sample of 100 observations and estimates the mean and standard error</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>researcher_sample <span class="ot">&lt;-</span> <span class="fu">sample</span>(population, <span class="dv">100</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>researcher_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(researcher_sample <span class="sc">~</span> <span class="dv">1</span>) <span class="co"># fancy way to estimate the mean</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>researcher_se <span class="ot">&lt;-</span> <span class="fu">summary</span>(researcher_model)<span class="sc">$</span>coefficients[<span class="dv">1</span>, <span class="st">"Std. Error"</span>]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Luckily, we are for once not limited to one sample.  We can draw many samples from the population and estimate the mean for each sample. Because of asymptotic statistics, the standard deviation of all these samples should be close to the standard error we estimated above.</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>N  <span class="ot">&lt;-</span>  <span class="dv">1000</span> <span class="co"># number of resamples</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>resampled_means <span class="ot">&lt;-</span> <span class="fu">replicate</span>(N, {</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    sample <span class="ot">&lt;-</span> <span class="fu">sample</span>(population, <span class="dv">100</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(sample)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="fu">aes</span>(resampled_means), <span class="at">fill =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"errorbarh"</span>,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmin =</span> <span class="fu">mean</span>(resampled_means) <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">sd</span>(resampled_means),</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">xmax =</span> <span class="fu">mean</span>(resampled_means) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">sd</span>(resampled_means),</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">height =</span> <span class="fl">0.1</span>,</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="dv">4</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>,</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">mean</span>(resampled_means), <span class="at">y =</span> <span class="dv">4</span>,</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Standard Deviation of</span><span class="sc">\n</span><span class="st">the Sampling Distribution"</span>),</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"segment"</span>,</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">mean</span>(resampled_means), <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> <span class="dv">4</span>,</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">annotate</span>(<span class="st">"text"</span>,</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">mean</span>(resampled_means), <span class="at">y =</span> <span class="dv">2</span>, <span class="at">yend =</span> <span class="dv">4</span>,</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="st">"Mean of Means"</span>, <span class="at">angle =</span> <span class="sc">-</span><span class="dv">90</span>,</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>))  </span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>sd_of_resampled_means <span class="ot">&lt;-</span> <span class="fu">sd</span>(resampled_means)</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Estimated SE from one sample: "</span>, <span class="fu">round</span>(sd_of_resampled_means, <span class="dv">5</span>)))</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Estimated SE from "</span>, N, <span class="st">" resamples: "</span>, <span class="fu">round</span>(researcher_se, <span class="dv">5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we have the standard error, we can obtain all other inferential statistics. The t-value is simply the coefficient divided by its standard error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>car_model_wt_t  <span class="ot">&lt;-</span> car_model<span class="sc">$</span>coefficients[<span class="st">"wt"</span>]<span class="sc">/</span>car_model_wt_se</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the p-value can be obtained once we know the t-value:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(car_model_wt_t), <span class="at">df =</span> car_model<span class="sc">$</span>df.residual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To get a better understanding of what the code above does, lets look at the probability density function of a t-distribution for 30 degrees of freedom (in the range from -15 tp 15).<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">15</span>, <span class="dv">15</span>, .<span class="dv">1</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>t_dist <span class="ot">&lt;-</span> <span class="fu">dt</span>(seq, <span class="at">df =</span> car_model<span class="sc">$</span>df.residual)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>t_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(seq, t_dist), <span class="fu">aes</span>(seq, t_dist)) <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"t-values"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Probability"</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, lets place the t-value we found on that distribution. With the <code>-abs</code> part, we make sure that we locate it on the left tail.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>t_plot <span class="sc">+</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fu">abs</span>(car_model_wt_t)), <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall, we want to estimate the probability of drawing a value as extreme (or even more extreme) than the one we obtained if the true value would be zero. That probability is the area under the curve left to the t-value we found.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggmagnify"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"hughjonesd/ggmagnify"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmagnify)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>t_plot <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fu">abs</span>(car_model_wt_t)), <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_area</span>(<span class="fu">aes</span>(seq, t_dist, <span class="at">fill =</span> seq <span class="sc">&lt;=</span> <span class="sc">-</span><span class="fu">abs</span>(car_model_wt_t))) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    ggmagnify<span class="sc">::</span><span class="fu">geom_magnify</span>(</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">from =</span> <span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="dv">15</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="dv">9</span>, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> .<span class="dv">0000000002</span>),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">15</span>, .<span class="dv">1</span>, .<span class="dv">3</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>t_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In case you were wondering why we had to make sure the t-value was negative: we could also have made sure that it was positive and then taken the area under the curve right to our calculated t-value. It makes no difference for the two-tailed test we are condcuting. We simply have to know the sign of our t-value in order to obtain the correct cumulative probability.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use R to obtain the cumulative probability (the green area under the curve) with the following code:</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(car_model_wt_t), <span class="at">df =</span> car_model<span class="sc">$</span>df.residual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, because we are conducting a two-tailed test, we multiply the value by 2. That way, we get the probability of finding a t-value as large as ours if the true value is 0, irrespective of our value being positive or negative. This is also why the <code>summary()</code> output reports the p-value as <code>Pr(&gt;|t|)</code>, which means “probability of finding a t-value as large or larger than the <em>absolute</em> value of the t-value we found if this is a draw from a t-distribution with a true mean of 0.”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span><span class="sc">*</span><span class="fu">pt</span>(<span class="sc">-</span><span class="fu">abs</span>(car_model_wt_t), <span class="at">df =</span> car_model<span class="sc">$</span>df.residual)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># compare this to the p-value we found in the summary output</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(car_model)<span class="sc">$</span>coefficients[<span class="st">"wt"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is also a goodness-of-fit block at the bottom of the output where you can see the residual standard error, the degrees of freedom, (adjusted) <span class="math inline">\(R^2\)</span>, the F-statistic and its p-value. The F-statistic helps us determine how much better our model fits the data in comparison to a model with just the intercept (which is equivalent to predicting for each <span class="math inline">\(i\)</span> that <span class="math inline">\(Y\)</span> is simply <span class="math inline">\(\mathbb{E}[Y]\)</span>). The tiny p-value indicates that a model with <code>wt</code> is a significantly better fit than such an intercept-only model.</p>
</section>
<section id="robust-bootstrapped-standard-errors" class="level2">
<h2 class="anchored" data-anchor-id="robust-bootstrapped-standard-errors">Robust &amp; Bootstrapped Standard Errors</h2>
<p>More frequently than not, some of the assumptions of linear regression are violated. Very commonly, the homoscedasticity assumption is violated. While we can still estimate informative coefficients, heteroscedasticity means that our asymptotic standard errors are biased. With heteroscedasticity, we often overestimate how precise our estimates are.</p>
<p>Luckily, that does not mean that we have to give up on ols or inference in such cases. There are two common approaches to deal with heteroscedasticity: robust standard errors and bootstrapped standard errors. The simulations below demonstrates that these approaches are robust to heteroscedasticity, while the asymptotic standard errors are not.</p>
<p>The simulation follows these steps:</p>
<ol type="1">
<li>Simulate a DGP in which one variable is correlated with the dependent variable and another variable is correlated with the variance of the error term, but not with the dependent variable.</li>
<li>Estimate a model with the dependent variable and the two independent variables.</li>
<li>Calculate the p-value for the uncorrelated independent variable using three different approaches.</li>
<li>Repeat the process 1000 times and calculate the share of significant results for each approach.</li>
</ol>
<p>You can inspect the code to familiarise yourself with bootstrapping and robust standard errors. Note that most of the time, you should simply use robust standard errors as a default by using the <code>estimatr::lm_robust()</code> function instead of <code>lm()</code>. This will automatically calculate robust standard errors for you.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, we define a function that simulates a simple DGP</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>simulate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">N =</span> <span class="dv">1000</span>, <span class="at">hc =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    X2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (hc) {</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># simulate heteroscedasticity by making the error term depend on X2</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        U <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, X2 <span class="sc">*</span> <span class="dv">10</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The function has an option to simulate data without </span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># heteroscedasticity, so we can compare the performance </span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># of different SE estimation methods on data with </span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and without heteroscedasticity.</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># simulate data without heteroscedasticity</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        U <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># simulate the dependent variable Y as a function of a constant, X, U and NOT X2</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    Y <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">20</span> <span class="sc">*</span> X <span class="sc">+</span> U</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">X =</span> X,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">X2 =</span> X2,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">Y =</span> Y</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="co"># define function that estimates bootstrapped standard errors. </span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Usually, you would use a package like {rboot} for this, but below you can see what happens under the hood.</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(model, <span class="at">n_boot =</span> <span class="dv">50</span>) {</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># retrieve the data from our model</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> model<span class="sc">$</span>model</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># retrieve the formula we used to estimate the model</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> model<span class="sc">$</span>call<span class="sc">$</span>formula</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and the number of observations</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initialise an empty matrix in which we can store our simulated coefficients</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>    boot_coefs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n_boot, <span class="fu">length</span>(<span class="fu">coef</span>(model))) </span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_boot) {</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sample with replacement from the data</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>        shuffled_data <span class="ot">&lt;-</span> data[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, n, <span class="at">replace =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate the model on the bootstrapped sample and extract coefficients</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>        boot_coefs[i, ] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(formula, <span class="at">data =</span> shuffled_data))</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># estimate the standard deviation of the coefficient distributions</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>    boot_se <span class="ot">&lt;-</span> <span class="fu">apply</span>(boot_coefs, <span class="dv">2</span>, sd)</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate t-statistics and p-values</span></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>    t_value <span class="ot">&lt;-</span> <span class="fu">coef</span>(model) <span class="sc">/</span> boot_se</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>    p_value <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pnorm</span>(<span class="sc">-</span><span class="fu">abs</span>(t_value))</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return output as dataframe</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">data.frame</span>(</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>            <span class="at">estimate =</span> <span class="fu">coef</span>(model),</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>            <span class="at">std.error =</span> boot_se,</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>            <span class="at">statistic =</span> t_value,</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>            <span class="at">p.value =</span> p_value</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a><span class="co"># function that calls the above functions once to simulate data, calculate the statistics, and test whether they are significant.</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>test_sig <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">N =</span> <span class="dv">1000</span>, hc, <span class="at">n_boot =</span> <span class="dv">100</span>) {</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> <span class="fu">simulate_data</span>(N, hc)</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> X <span class="sc">+</span> X2, <span class="at">data =</span> df)</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>    model_robust <span class="ot">&lt;-</span> estimatr<span class="sc">::</span><span class="fu">lm_robust</span>(Y <span class="sc">~</span> X <span class="sc">+</span> X2, <span class="at">data =</span> df)</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract the p-values calculated with ordinary, bootstrapped, </span></span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and robust standard errors</span></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>    p_simple <span class="ot">&lt;-</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients[<span class="st">"X2"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>    p_bootstrap <span class="ot">&lt;-</span> <span class="fu">bootstrap</span>(model, <span class="at">n_boot =</span> n_boot)[<span class="st">"X2"</span>, <span class="st">"p.value"</span>]</span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>    p_robust <span class="ot">&lt;-</span> model_robust<span class="sc">$</span>p.value[<span class="st">"X2"</span>]</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return 1 if p-value is significant at 0.05, 0 otherwise</span></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>    p_simple_sig <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(p_simple <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>    p_bootstrap_sig <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(p_bootstrap <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>    p_robust_sig <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(p_robust <span class="sc">&lt;</span> <span class="fl">0.05</span>)</span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_simple_sig =</span> p_simple_sig,</span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_bootstrap_sig =</span> p_bootstrap_sig,</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">p_robust_sig =</span> p_robust_sig</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The code below will take a while to run. You can use the <code>eval=FALSE</code> option if you don’t want to execute it when you knit your quarto document.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run 1000 simulations without heteroscedasticity</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>simulation_results_nohc <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>, <span class="cf">function</span>(i) {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">test_sig</span>(<span class="at">N =</span> <span class="dv">1000</span>, <span class="at">hc =</span> F, <span class="at">n_boot =</span> <span class="dv">99</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># run 1000 simulations with heteroscedasticity</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>simulation_results_hc <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>, <span class="cf">function</span>(i) {</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">test_sig</span>(<span class="at">N =</span> <span class="dv">1000</span>, <span class="at">hc =</span> T, <span class="at">n_boot =</span> <span class="dv">99</span>) </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, let’s calculate share of significant results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(simulation_results_nohc, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">as.numeric</span>(x)))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(simulation_results_hc, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">mean</span>(<span class="fu">as.numeric</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see, the share of significant results (recall, there is no effect of <code>X2</code>, so all these are type I errors!) is around 5% for the bootstrapped and robust standard errors, but higher for the ordinary standard errors when heteroscedasticity is present. There should not be a big difference when there is no heteroscedasticity.</p>
</section>
</section>
<section id="by-the-end-of-this-seminar-you-should-be-able-to" class="level1">
<h1>By the end of this seminar, you should be able to…</h1>
<ul>
<li><p>Estimate multivariate linear regression models using <code>lm()</code>,</p></li>
<li><p>Retrieve and interpret the intercept, coefficients, standard errors, t-values, p-values, and confidence-intervals from the model output,</p></li>
<li><p>judge how well a model fits the data by interpretting the <span class="math inline">\(R^2\)</span>,</p></li>
<li><p>Use the <code>predict()</code> function to make predictions based on a fitted model,</p></li>
<li><p>Retrieve and interpret model diagnostics and residual plots</p></li>
</ul>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>In regression, the degrees of freedom are equal to the number of observations minus the number of coefficients estimated. In our case, we have 32 observations and estimate 2 coefficients (intercept and slope), so we have 30 degrees of freedom.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>